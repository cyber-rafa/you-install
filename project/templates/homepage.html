<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='ico.png') }}" type="image/png">
    <link rel="icon" href="{{ url_for('static', filename='ico.png') }}" type="image/png">
    <title>Download de V√≠deos</title>
    <script src="{{ url_for('static', filename='favicon-animation.js') }}"></script>
    <script src="{{ url_for('static', filename='loading-animation.js') }}"></script>
</head>
<body>
    <div class="container">
        <h1>Download de V√≠deos do YouTube</h1>
        
        <div id="ffmpeg-status-bar" class="{{ 'ffmpeg-available' if ffmpeg_available else 'ffmpeg-missing' }}">
            <div class="ffmpeg-icon">{{ '‚úì' if ffmpeg_available else '!' }}</div>
            <div class="ffmpeg-message">
                {% if ffmpeg_available %}
                    FFmpeg instalado. Todas as resolu√ß√µes est√£o dispon√≠veis.
                {% else %}
                    FFmpeg n√£o instalado. Resolu√ß√µes acima de 720p requerem FFmpeg.
                    <button id="download-ffmpeg-btn" class="install-btn">Instalar automaticamente</button>
                    <span>ou</span>
                    <a href="/install-instructions" class="install-btn">Instru√ß√µes manuais</a>
                {% endif %}
            </div>
        </div>
        
        <div id="download-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Baixando FFmpeg</h3>
                <p>Isso pode levar alguns minutos dependendo da sua conex√£o de internet.</p>
                <div class="progress-container">
                    <div class="progress-bar" id="download-progress"></div>
                </div>
                <p id="download-status">Iniciando download...</p>
            </div>
        </div>

        <form id="videoForm">
            <label for="url">Insira a URL do v√≠deo ou playlist:</label>
            <div class="url-input-container">
                <input type="text" id="url" name="url" required placeholder="https://www.youtube.com/watch?v=..." autocomplete="off">
            </div>
            <button type="button" onclick="fetchVideoInfo()" class="search-btn">
                <span class="btn-text">Buscar Informa√ß√µes</span>
                <span class="btn-icon">üîç</span>
            </button>
        </form>

        <div id="videoInfo" style="display: none;">
            <div class="video-details">
                <div class="thumbnail-container">
                    <img id="videoThumbnail" alt="Thumbnail do v√≠deo">
                </div>
                <div class="video-meta">
                    <h2 id="videoTitle"></h2>
                    <p><span id="videoUploader"></span> ‚Ä¢ <span id="videoViews"></span> visualiza√ß√µes</p>
                    <p>Dura√ß√£o: <span id="videoDuration"></span></p>
                </div>
            </div>
        </div>

        <div id="qualitySection" style="display: none;">
            <h2>Escolha a Qualidade</h2>
            <form id="downloadForm">
                <input type="hidden" id="downloadUrl" name="url">
                <div class="quality-options">
                    <select id="qualitySelect" name="itag"></select>
                    <div id="qualityInfo" class="quality-info"></div>
                </div>
                <div id="resolution-info" class="info-message">
                    <p>Informa√ß√µes sobre o download:</p>
                    <ul>
                        <li>Todas as resolu√ß√µes dispon√≠veis</li>
                        <li>√Åudio e v√≠deo em alta qualidade</li>
                        <li>Download r√°pido e direto</li>
                    </ul>
                </div>
                <button type="submit" class="download-btn">
                    <span class="btn-icon">‚¨áÔ∏è</span>
                    <span class="btn-text">Baixar V√≠deo</span>
                </button>
            </form>
        </div>

        <div id="playlistSection" style="display: none;">
            <h2>Informa√ß√µes da Playlist</h2>
            <div class="playlist-info">
                <h3 id="playlistTitle"></h3>
                <p><span id="playlistCount"></span> v√≠deos</p>
            </div>
            <form id="playlistForm">
                <input type="hidden" id="playlistUrl" name="url">
                <div class="quality-options">
                    <label for="playlistQuality">Qualidade m√°xima:</label>
                    <select id="playlistQuality" name="quality">
                        <option value="720">720p</option>
                        <option value="1080">1080p</option>
                        <option value="1440">1440p (2K)</option>
                        <option value="2160">2160p (4K)</option>
                    </select>
                </div>
                <p class="warning">Aten√ß√£o: Baixar uma playlist completa pode levar tempo e ocupar bastante espa√ßo em disco.</p>
                <button type="submit" class="download-btn">
                    <span class="btn-icon">üìã‚¨áÔ∏è</span>
                    <span class="btn-text">Baixar Playlist</span>
                </button>
            </form>
        </div>

        <div id="status" class="status-message" style="display: none;"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const downloadBtn = document.getElementById('download-ffmpeg-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadFFmpeg);
            }
            
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    resetSearch();
                }
            });
            
            addFormAnimations();
        });
        
        function addFormAnimations() {
            const searchInput = document.getElementById('url');
            
            searchInput.addEventListener('focus', function() {
                this.parentElement.classList.add('active-form');
            });
            
            searchInput.addEventListener('blur', function() {
                if (!this.value) {
                    this.parentElement.classList.remove('active-form');
                }
            });
            
            searchInput.addEventListener('input', function() {
                if (this.value) {
                    this.classList.add('has-content');
                } else {
                    this.classList.remove('has-content');
                }
            });
            
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple-effect');
                    this.appendChild(ripple);
                    
                    const x = e.clientX - e.target.getBoundingClientRect().left;
                    const y = e.clientY - e.target.getBoundingClientRect().top;
                    ripple.style.left = `${x}px`;
                    ripple.style.top = `${y}px`;
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });
        }
        
        function resetSearch() {
            document.getElementById("url").value = "";
            document.getElementById("url").classList.remove("has-content");
            document.getElementById("url").parentElement.classList.remove("active-form");
            
            document.getElementById("videoInfo").style.display = "none";
            document.getElementById("qualitySection").style.display = "none";
            document.getElementById("playlistSection").style.display = "none";
            document.getElementById("status").style.display = "none";
            
            document.getElementById("status").classList.remove("show");
            document.body.classList.remove("downloading");
            document.body.classList.remove("download-completed");
            
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            document.getElementById("videoForm").style.display = "block";
            
            document.querySelectorAll('button.loading').forEach(button => {
                button.classList.remove('loading');
                button.disabled = false;
            });
            
            document.querySelectorAll('a[style*="display: none"]').forEach(element => {
                if (element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            });
            
            document.getElementById("url").focus();
            
            window.scrollTo({top: 0, behavior: 'smooth'});
            
            const searchButton = document.querySelector("#videoForm button");
            if (searchButton.classList.contains('loading')) {
                hideLoadingAnimation();
            }
            
            if (window.loadingAnimation && window.loadingAnimation.isActive) {
                stopLoading();
            }
        }
        
        function downloadFFmpeg() {
            const modal = document.getElementById('download-modal');
            const progressBar = document.getElementById('download-progress');
            const statusText = document.getElementById('download-status');
            
            modal.style.display = 'flex';
            statusText.textContent = 'Iniciando download do FFmpeg...';
            progressBar.style.width = '5%';
            
            fetch('/check-ffmpeg')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'installed' || data.status === 'available') {
                        progressBar.style.width = '100%';
                        statusText.textContent = 'FFmpeg instalado com sucesso!';
                        setTimeout(() => {window.location.reload();}, 2000);
                    } else {
                        progressBar.style.width = '50%';
                        statusText.textContent = 'Falha ao instalar FFmpeg. Tente a instala√ß√£o manual.';
                        setTimeout(() => {modal.style.display = 'none';}, 3000);
                    }
                })
                .catch(error => {
                    statusText.textContent = 'Erro ao instalar FFmpeg: ' + error;
                    setTimeout(() => {modal.style.display = 'none';}, 3000);
                });
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('pt-BR').format(num);
        }

        function updateStatus(message, isError = false) {
            const statusElement = document.getElementById("status");
            statusElement.textContent = message;
            statusElement.className = "status-message" + (isError ? " error" : " success");
            
            statusElement.classList.remove("show");
            
            statusElement.style.display = "block";
            statusElement.style.opacity = "0";
            statusElement.style.maxHeight = "0";
            
            void statusElement.offsetWidth;
            
            setTimeout(() => {
                statusElement.classList.add("show");
                statusElement.style.opacity = "1";
                statusElement.style.maxHeight = "100px";
            }, 10);
        }

        function showLoadingAnimation() {
            const searchButton = document.querySelector("#videoForm button");
            searchButton.disabled = true;
            searchButton.innerHTML = '<span class="btn-loading-spinner"></span>';
            searchButton.classList.add('loading');
        }

        function hideLoadingAnimation() {
            const searchButton = document.querySelector("#videoForm button");
            searchButton.disabled = false;
            searchButton.innerHTML = '<span class="btn-text">Buscar Informa√ß√µes</span><span class="btn-icon">üîç</span>';
            searchButton.classList.remove('loading');
        }

        function fetchVideoInfo() {
            const url = document.getElementById("url").value.trim();
            if (!url) {
                updateStatus("Por favor, insira uma URL v√°lida", true);
                return;
            }

            showLoadingAnimation();
            updateStatus("Buscando informa√ß√µes do v√≠deo...");

            fetch("/get_video_info", {
                method: "POST",
                body: new URLSearchParams({ url: url }),
                headers: { "Content-Type": "application/x-www-form-urlencoded" }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || "Erro ao buscar informa√ß√µes do v√≠deo");
                    });
                }
                return response.json();
            })
            .then(data => {
                hideLoadingAnimation();
                document.getElementById("status").style.display = "none";
                
                if (data.type === "video" || (!data.type && !data.is_playlist)) {
                    displayVideoInfo(data);
                } else if (data.type === "playlist" || data.is_playlist) {
                    displayPlaylistInfo(data);
                }
            })
            .catch(error => {
                hideLoadingAnimation();
                updateStatus("Erro: " + error.message, true);
            });
        }

        function displayVideoInfo(data) {
            document.getElementById("videoTitle").textContent = data.title || "Sem t√≠tulo";
            document.getElementById("videoThumbnail").src = data.thumbnail || "";
            document.getElementById("videoUploader").textContent = data.uploader || "Desconhecido";
            document.getElementById("videoViews").textContent = formatNumber(data.view_count || 0);
            document.getElementById("videoDuration").textContent = formatDuration(data.duration || 0);
            
            document.getElementById("videoInfo").style.display = "block";
            document.getElementById("downloadUrl").value = data.url || url.value;
            
            const qualitySelect = document.getElementById("qualitySelect");
            qualitySelect.innerHTML = "";
            
            if (data.formats && Array.isArray(data.formats)) {
                data.formats.forEach(format => {
                    const option = document.createElement("option");
                    option.value = format.itag;
                    
                    let label = `${format.resolution}${format.fps > 30 ? ' (' + format.fps + 'fps)' : ''}`;
                    if (format.size) {
                        label += ` - ${format.size}`;
                    }
                    
                    option.textContent = label;
                    option.dataset.info = JSON.stringify(format);
                    qualitySelect.appendChild(option);
                });
            } else if (data.resolutions && typeof data.resolutions === 'object') {
                const resolutions = data.resolutions;
                const resInfo = data.resolutions_info || {};
                
                Object.keys(resolutions).forEach(resolution => {
                    const formatId = resolutions[resolution];
                    const info = resInfo[resolution] || {};
                    
                    const option = document.createElement("option");
                    option.value = formatId;
                    
                    let label = resolution;
                    if (info.fps && info.fps > 30) {
                        label += ` (${info.fps}fps)`;
                    }
                    if (info.filesize) {
                        label += ` - ${info.filesize}`;
                    }
                    
                    option.textContent = label;
                    
                    const formatInfo = {
                        resolution: resolution,
                        fps: info.fps || 0,
                        vcodec: info.requires_ffmpeg ? "Separado (requer FFmpeg)" : "Integrado",
                        size: info.filesize || "Desconhecido"
                    };
                    
                    option.dataset.info = JSON.stringify(formatInfo);
                    qualitySelect.appendChild(option);
                });
            } else {
                const option = document.createElement("option");
                option.value = "best";
                option.textContent = "Melhor qualidade dispon√≠vel";
                option.dataset.info = JSON.stringify({
                    resolution: "Auto",
                    fps: 0,
                    vcodec: "Auto",
                    size: "Desconhecido"
                });
                qualitySelect.appendChild(option);
            }
            
            qualitySelect.addEventListener("change", function() {
                const selectedOption = this.options[this.selectedIndex];
                if (!selectedOption || !selectedOption.dataset.info) return;
                
                try {
                    const formatInfo = JSON.parse(selectedOption.dataset.info);
                    
                    const qualityInfo = document.getElementById("qualityInfo");
                    qualityInfo.innerHTML = `
                        <div class="info-item"><span>Resolu√ß√£o:</span> ${formatInfo.resolution}</div>
                        <div class="info-item"><span>FPS:</span> ${formatInfo.fps}</div>
                        <div class="info-item"><span>Codec:</span> ${formatInfo.vcodec}</div>
                        <div class="info-item"><span>Tamanho:</span> ${formatInfo.size || "Desconhecido"}</div>
                    `;
                } catch (e) {
                    console.error("Erro ao processar informa√ß√µes de formato:", e);
                }
            });
            
            if (qualitySelect.options.length > 0) {
                qualitySelect.dispatchEvent(new Event("change"));
            }
            
            document.getElementById("qualitySection").style.display = "block";
            document.getElementById("playlistSection").style.display = "none";
        }

        function displayPlaylistInfo(data) {
            document.getElementById("qualitySection").style.display = "none";
            
            document.getElementById("videoInfo").style.display = "block";
            document.getElementById("videoTitle").textContent = "Playlist: " + data.title;
            document.getElementById("videoThumbnail").src = data.thumbnail;
            document.getElementById("videoUploader").textContent = data.uploader || "YouTube";
            document.getElementById("videoViews").textContent = "";
            document.getElementById("videoDuration").textContent = "";
            
            document.getElementById("playlistTitle").textContent = data.title;
            document.getElementById("playlistCount").textContent = data.video_count;
            document.getElementById("playlistUrl").value = data.url;
            
            document.getElementById("playlistSection").style.display = "block";
        }

        document.getElementById("downloadForm").addEventListener("submit", function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            
            document.body.classList.add('downloading');
            
            startLoading("Baixando v√≠deo...");
            let downloadUrl = null;
            let downloadElement = null;
            
            const downloadButton = this.querySelector("button[type='submit']");
            if (downloadButton) {
                downloadButton.disabled = true;
                downloadButton.classList.add("loading");
            }
            
            fetch("/download", {
                method: "POST",
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || "Erro no download");
                    });
                }
                updateLoading(70, "Preparando arquivo para download...");
                return response.blob();
            })
            .then(blob => {
                try {
                    document.getElementById("videoInfo").style.transform = "translateZ(0)";
                    document.getElementById("qualitySection").style.transform = "translateZ(0)";
                    
                    downloadUrl = window.URL.createObjectURL(blob);
                    downloadElement = document.createElement("a");
                    downloadElement.href = downloadUrl;
                    downloadElement.download = document.getElementById("videoTitle").textContent + ".mp4";
                    downloadElement.style.display = "none";
                    downloadElement.setAttribute("aria-hidden", "true");
                    downloadElement.setAttribute("tabindex", "-1");
                    document.body.appendChild(downloadElement);
                    
                    updateLoading(90, "Iniciando download...");
                    return new Promise(resolve => {
                        setTimeout(() => {
                            downloadElement.click();
                            resolve();
                        }, 300);
                    });
                } catch (error) {
                    throw new Error("Falha ao iniciar o download");
                }
            })
            .then(() => {
                document.body.classList.add('download-completed');
                document.body.classList.remove('downloading');
                
                updateStatus("Download conclu√≠do com sucesso!");
                
                setTimeout(() => {
                    resetSearch();
                }, 3000);
            })
            .catch(error => {
                updateStatus("Erro: " + error.message, true);
                document.body.classList.remove('downloading');
            })
            .finally(() => {
                if (downloadButton) {
                    downloadButton.disabled = false;
                    downloadButton.classList.remove("loading");
                }
                
                stopLoading();
                
                if (downloadElement && downloadElement.parentNode) {
                    try {
                        document.body.removeChild(downloadElement);
                    } catch (e) {}
                }
                
                if (downloadUrl) {
                    try {
                        window.URL.revokeObjectURL(downloadUrl);
                    } catch (e) {}
                }
                
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            });
        });
        
        document.getElementById("playlistForm").addEventListener("submit", function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            
            startLoading("Iniciando download da playlist...");
            updateLoading(10, "Este processo pode levar algum tempo para playlists grandes");

            fetch("/download_playlist", {
                method: "POST",
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || "Erro no download da playlist");
                    });
                }
                updateLoading(80, "Playlist sendo processada pelo servidor...");
                return response.text();
            })
            .then(text => {
                updateStatus("Playlist sendo baixada! Os v√≠deos ser√£o salvos na pasta 'downloads/playlist'");
                setTimeout(() => {
                    resetSearch();
                }, 3000);
            })
            .catch(error => {
                updateStatus("Erro: " + error.message, true);
            })
            .finally(() => {
                stopLoading();
                window.scrollTo({top: 0, behavior: 'smooth'});
            });
        });
        
        (function() {
            const style = document.createElement('style');
            style.textContent = `
                button {position: relative; overflow: hidden;}
                .ripple-effect {
                    position: absolute;
                    border-radius: 50%;
                    background-color: rgba(255, 255, 255, 0.7);
                    width: 100px;
                    height: 100px;
                    margin-top: -50px;
                    margin-left: -50px;
                    animation: ripple 0.6s;
                    opacity: 0;
                }
                @keyframes ripple {
                    0% {transform: scale(0); opacity: 0.5;}
                    100% {transform: scale(4); opacity: 0;}
                }
                button.loading {
                    background-color: #0056b3 !important;
                    cursor: wait;
                }
                .btn-loading-spinner {
                    display: inline-block;
                    width: 24px;
                    height: 24px;
                    border: 3px solid rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    border-top-color: white;
                    animation: spin 1s linear infinite;
                }
                @keyframes spin {
                    0% {transform: rotate(0deg);}
                    100% {transform: rotate(360deg);}
                }
                .active-form {
                    transform: scale(1.02);
                    transition: all 0.3s ease;
                }
                input.has-content {
                    border-color: #4CAF50 !important;
                    box-shadow: 0 0 5px rgba(76, 175, 80, 0.5) !important;
                }
            `;
            document.head.appendChild(style);
        })();
    </script>

</body>
</html>
